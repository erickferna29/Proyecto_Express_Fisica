<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ELECTRO MINI-GOLF: Physics Engine</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #1a472a; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        canvas { display: block; border: 10px solid #2e2e2e; box-sizing: border-box; }
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #fff;
            pointer-events: none;
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #daa520;
        }
        h1 { margin: 0; font-size: 28px; text-transform: uppercase; color: #daa520; text-shadow: 2px 2px 0 #000; }
        p { margin: 5px 0; font-size: 16px; font-weight: bold; }
        .win-msg {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #ffd700;
            font-size: 80px;
            font-weight: 900;
            text-shadow: 4px 4px 0 #000;
            display: none;
            text-align: center;
            background: rgba(0,0,0,0.8);
            padding: 40px;
            border-radius: 20px;
            border: 5px solid #fff;
            z-index: 100;
        }
        #powerBarContainer {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            height: 20px;
            background: #000;
            border: 2px solid white;
            border-radius: 10px;
            display: none;
        }
        #powerBarFill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, lime, yellow, red);
            border-radius: 8px;
        }
    </style>
</head>
<body>

    <div id="ui">
        <h1>⛳ Electro Mini-Golf</h1>
        <p>Tiros: <span id="strokeCount">0</span></p>
        <p>Carga Bola: +10µC</p>
        <p style="color:#ff4444">Trampa Roja: Repele (+)</p>
        <p style="color:#44ccff">Trampa Azul: Atrae (-)</p>
    </div>

    <div id="winMsg" class="win-msg">¡HOYO EN UNO!<br><span style="font-size:30px; color:white;">Presiona R para siguiente nivel</span></div>
    
    <div id="powerBarContainer"><div id="powerBarFill"></div></div>

    <canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    // Ajustar pantalla
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // --- FÍSICA CALIBRADA (NO LE MUEVAS AQUÍ SI NO SABES) ---
    const K = 25000;     // Fuerza eléctrica
    const DT = 0.5;      // Delta Time
    const FRICTION = 0.965; // Fricción del pasto (Menor a 1 frena)
    const MAX_POWER = 25; // ¡ESTO ARREGLA LA FUERZA! Tope de velocidad
    const POWER_SENSITIVITY = 0.12; // Qué tanto estiras el mouse vs potencia

    // Variables de Juego
    let strokes = 0;
    
    // El Hoyo (La Meta)
    const hole = { x: canvas.width * 0.85, y: canvas.height / 2, r: 25 };

    // Obstáculos (Trampas Eléctricas)
    const cx = canvas.width / 2;
    const cy = canvas.height / 2;
    const obstacles = [
        { x: cx - 150, y: cy - 100, q: 60, r: 40, color: '#ff3333', type: 'Repulsor' }, // Rojo
        { x: cx + 150, y: cy + 100, q: -50, r: 40, color: '#00ccff', type: 'Atractor' }, // Azul
        { x: cx, y: cy - 200, q: 80, r: 50, color: '#ff3333', type: 'Repulsor' }       // Rojo Grande
    ];

    // La Bola
    let ball = {
        x: 150, y: cy,
        vx: 0, vy: 0,
        q: 10, r: 12,
        moving: false
    };

    // Mouse
    let isDragging = false;
    let dragStart = { x: 0, y: 0 };
    let dragCurrent = { x: 0, y: 0 };

    function update() {
        if (ball.moving) {
            let fx = 0;
            let fy = 0;

            // 1. FÍSICA ELÉCTRICA (Coulomb)
            obstacles.forEach(obs => {
                let dx = ball.x - obs.x;
                let dy = ball.y - obs.y;
                let distSq = dx*dx + dy*dy;
                let dist = Math.sqrt(distSq);

                // Colisión con obstáculos (Rebote elástico simple)
                if (dist < obs.r + ball.r) {
                    let angle = Math.atan2(dy, dx);
                    let speed = Math.sqrt(ball.vx*ball.vx + ball.vy*ball.vy);
                    ball.vx = Math.cos(angle) * speed * 0.8; // Rebote pierde energía
                    ball.vy = Math.sin(angle) * speed * 0.8;
                    ball.x += Math.cos(angle) * 2; // Despegar para no pegarse
                    ball.y += Math.sin(angle) * 2;
                }

                if (dist > 10) { 
                    // F = k*q1*q2 / r^2
                    let F = (K * ball.q * obs.q) / distSq;
                    fx += F * (dx / dist);
                    fy += F * (dy / dist);
                }
            });

            // 2. APLICAR NEWTON
            ball.vx += fx * DT;
            ball.vy += fy * DT;

            // 3. APLICAR FRICCIÓN DE PASTO (Esto frena la bola)
            ball.vx *= FRICTION;
            ball.vy *= FRICTION;

            // Parar si es muy lento (Sleep threshold)
            if (Math.abs(ball.vx) < 0.1 && Math.abs(ball.vy) < 0.1) {
                ball.moving = false;
                ball.vx = 0;
                ball.vy = 0;
            }

            // 4. MOVER
            ball.x += ball.vx * DT;
            ball.y += ball.vy * DT;

            // 5. REBOTE EN PAREDES (Muros del Mini Golf)
            if (ball.x < ball.r) { ball.x = ball.r; ball.vx *= -0.8; }
            if (ball.x > canvas.width - ball.r) { ball.x = canvas.width - ball.r; ball.vx *= -0.8; }
            if (ball.y < ball.r) { ball.y = ball.r; ball.vy *= -0.8; }
            if (ball.y > canvas.height - ball.r) { ball.y = canvas.height - ball.r; ball.vy *= -0.8; }

            // 6. CHECAR GANE
            let dxH = ball.x - hole.x;
            let dyH = ball.y - hole.y;
            if (Math.sqrt(dxH*dxH + dyH*dyH) < hole.r) {
                ball.moving = false;
                ball.vx = 0; ball.vy = 0;
                ball.x = hole.x; ball.y = hole.y; // Imán al hoyo
                document.getElementById('winMsg').style.display = 'block';
            }
        }
    }

    function draw() {
        // Fondo PASTO (Pattern simple)
        ctx.fillStyle = '#2e8b57'; // Sea Green
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Cuadricula sutil (para que se vea técnico)
        ctx.strokeStyle = 'rgba(255,255,255,0.1)';
        ctx.lineWidth = 1;
        for(let i=0; i<canvas.width; i+=50) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,canvas.height); ctx.stroke(); }
        for(let i=0; i<canvas.height; i+=50) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(canvas.width,i); ctx.stroke(); }

        // DIBUJAR HOYO
        ctx.beginPath();
        ctx.arc(hole.x, hole.y, hole.r, 0, Math.PI * 2);
        ctx.fillStyle = '#111';
        ctx.fill();
        ctx.lineWidth = 3;
        ctx.strokeStyle = '#fff';
        ctx.stroke();
        // Bandera
        ctx.beginPath();
        ctx.moveTo(hole.x, hole.y);
        ctx.lineTo(hole.x, hole.y - 60); // Asta
        ctx.stroke();
        ctx.fillStyle = 'red';
        ctx.beginPath();
        ctx.moveTo(hole.x, hole.y - 60);
        ctx.lineTo(hole.x + 20, hole.y - 50);
        ctx.lineTo(hole.x, hole.y - 40);
        ctx.fill();

        // DIBUJAR OBSTÁCULOS
        obstacles.forEach(obs => {
            ctx.beginPath();
            ctx.arc(obs.x, obs.y, obs.r, 0, Math.PI * 2);
            // Gradiente para que se vea 3D
            let grd = ctx.createRadialGradient(obs.x - 10, obs.y - 10, 5, obs.x, obs.y, obs.r);
            grd.addColorStop(0, '#fff');
            grd.addColorStop(1, obs.color);
            ctx.fillStyle = grd;
            ctx.fill();
            ctx.strokeStyle = 'rgba(0,0,0,0.5)';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Signo + o -
            ctx.fillStyle = '#fff';
            ctx.font = "bold 24px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(obs.q > 0 ? "+" : "-", obs.x, obs.y);
        });

        // DIBUJAR BOLA
        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.r, 0, Math.PI * 2);
        ctx.fillStyle = '#fff'; // Bola blanca clásica
        ctx.fill();
        // Sombra simulada
        ctx.beginPath();
        ctx.arc(ball.x - 3, ball.y - 3, ball.r/2, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(0,0,0,0.1)';
        ctx.fill();
        ctx.strokeStyle = '#000';
        ctx.lineWidth = 1;
        ctx.stroke();

        // DIBUJAR FLECHA DE TIRO
        if (isDragging && !ball.moving) {
            let dx = dragStart.x - dragCurrent.x;
            let dy = dragStart.y - dragCurrent.y;
            let dist = Math.sqrt(dx*dx + dy*dy);
            
            // Calcular potencia visual (0 a 100%)
            let power = Math.min(dist * POWER_SENSITIVITY, MAX_POWER);
            let percent = (power / MAX_POWER) * 100;
            
            // Actualizar barra HTML
            document.getElementById('powerBarFill').style.width = percent + "%";

            // Dibujar línea en canvas
            ctx.beginPath();
            ctx.moveTo(ball.x, ball.y);
            let aimX = ball.x + dx; // Dirección inversa (resortera)
            let aimY = ball.y + dy;
            ctx.lineTo(aimX, aimY);
            ctx.lineWidth = 5;
            // Color cambia de verde a rojo según fuerza
            ctx.strokeStyle = `hsl(${120 - percent * 1.2}, 100%, 50%)`; 
            ctx.stroke();
            
            // Bola fantasma (apuntado)
            ctx.beginPath();
            ctx.arc(aimX, aimY, 5, 0, Math.PI*2);
            ctx.fillStyle = 'rgba(255,255,255,0.5)';
            ctx.fill();
        }

        requestAnimationFrame(loop);
    }

    function loop() {
        update();
        draw();
    }

    // --- CONTROLES ---
    canvas.addEventListener('mousedown', e => {
        if (ball.moving) return;
        isDragging = true;
        dragStart = { x: e.clientX, y: e.clientY };
        dragCurrent = { x: e.clientX, y: e.clientY };
        document.getElementById('powerBarContainer').style.display = 'block';
    });

    canvas.addEventListener('mousemove', e => {
        if (isDragging) {
            dragCurrent = { x: e.clientX, y: e.clientY };
        }
    });

    canvas.addEventListener('mouseup', e => {
        if (!isDragging) return;
        isDragging = false;
        document.getElementById('powerBarContainer').style.display = 'none';

        let dx = dragStart.x - e.clientX;
        let dy = dragStart.y - e.clientY;
        
        // CALIBRACIÓN DE FUERZA MEJORADA
        let dist = Math.sqrt(dx*dx + dy*dy);
        let power = Math.min(dist * POWER_SENSITIVITY, MAX_POWER); // Clamp
        
        let angle = Math.atan2(dy, dx);
        
        ball.vx = Math.cos(angle) * power;
        ball.vy = Math.sin(angle) * power;
        
        if (power > 1) { // Solo disparar si jaló tantito
            ball.moving = true;
            strokes++;
            document.getElementById('strokeCount').innerText = strokes;
        }
    });

    window.addEventListener('keydown', e => {
        if (e.key === 'r' || e.key === 'R') {
            ball.x = 150; ball.y = cy;
            ball.vx = 0; ball.vy = 0;
            ball.moving = false;
            document.getElementById('winMsg').style.display = 'none';
        }
    });

    loop();
</script>
</body>
</html>